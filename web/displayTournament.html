<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SULTSTUA</title>
    <link rel="stylesheet" href="main.css"/>
</head>
<body>
    <header>
        <h1 class="header">
        </h1>
        <h2>
            <span class="logged-in">
                Logged in as <span id="loggedInAs"></span>
                <button id="logout-button">
                    Log out
                </button>
            </span>
            <span class="logged-out">
                <button id="login-button">
                    Log in
                </button>
            </span>
            <style>
                body[data-user] .logged-out {
                    display: none;
                }
                body:not([data-user]) .logged-in {
                    display: none;
                }
            </style>
        </h2>
        <script>
            let userName = localStorage.getItem("userName");
            if(userName) {
                document.body.setAttribute("data-user", userName);
                document.getElementById("loggedInAs").innerText = userName;
            } else {
                document.body.removeAttribute("data-user");
            }


            let loginButton = document.getElementById("login-button");
            loginButton.addEventListener("click", () => {
                let userName = prompt("Who are you?");
                console.log("userName", userName);
                if(!userName){
                    return;
                }
                localStorage.setItem('userName', userName);
                document.body.setAttribute("data-user", userName);
                document.getElementById("loggedInAs").innerText = userName;
            })
            let logoutButton = document.getElementById("logout-button");
            logoutButton.addEventListener("click", () => {
                localStorage.removeItem('userName');
                document.body.removeAttribute("data-user");
                document.getElementById("loggedInAs").innerText = "";
            })
        </script>
    </header>
    <div id="list" class="list">

    </div>
</body>
<script>

    let searchParams = new URLSearchParams(window.location.search);
    let tourId = searchParams.get("tournamentId");

    function createCellFromTemplate(anime){
    let template = document.getElementById("list-cell-template");
    let fragment = template.content.cloneNode(true);

    fragment.querySelector(".poster").setAttribute("src", anime.coverImage.large)
    fragment.querySelector(".cell").setAttribute("style", `--poster-color:${anime.coverImage.color};`);


    let title;
    if(anime.title.english) {
        title = anime.title.english;
    } else {
        title = anime.title.romaji;
    }
    fragment.querySelector(".title").innerText = title;


    if(anime.trailer){
        let trailerHref;
        if(anime.trailer.site === "youtube"){
            trailerHref = `https://www.youtube.com/watch?v=${anime.trailer.id}`
        } else {
            trailerHref = "#";
        }
        fragment.querySelector(".trailer a").href = trailerHref;
    } else {
        fragment.querySelector(".trailer a").remove();
    }

    fragment.querySelector(".synopsis").innerHTML = anime.description;

    let tags = fragment.querySelector(".tags");
    for(let genre of anime.genres){
        let tagElement = document.createElement("div");
        tagElement.classList.add("tag");
        tagElement.dataset["tag"] = genre.toLowerCase();
        tagElement.innerText = genre;
        tags.appendChild(tagElement);
    }

    let points = fragment.querySelector(".points");
    points.innerText = "N/A";

    function askForScore(){
        let score = prompt("Give a score between 0 and 100");
        if(score == null){
            return;
        }
        score = parseInt(score);
        if(isNaN(score) || score < 0 || score > 100){
            alert("Score must be a number between 0 and 100.");
            return askForScore();
        }

        console.log("user", userName, "gave score", score, "to anime", anime.id, title)
    }
    points.addEventListener("click", askForScore)


    return fragment;
}

function makeList(listOfAni){
        let list = document.getElementById("list");
        
        for(let tour of listOfAni){
            list.append(createCellFromTemplate(tour));
        }
    }

    async function onLoad(){
        let response = await fetch("http://localhost:5000/getTournament/"+tourId, {
            "method": "GET",
            "mode": "cors",
            "credentials": "omit"
        });
        let json = await response.json();
        document.querySelector(".header").innerText=json.tournamentName
        makeList(json.animes);

    }
    window.addEventListener("load", onLoad);




</script>

<template id="list-cell-template">
        <div class="cell">
            <div class="splash">
                <img class="poster" src="" alt="">
            </div>
            <div class="info">
                <h3 class="title"> 
                </h3>
                <div class="trailer">
                    <a>Trailer</a>
                </div>
                <div class="synopsis">
                </div>
                <div class="tags">
                </div>
                <div class="points">
                </div>
            </div>
        </div>
</template>

<template>
    <form class="score-form">
        <input type="hidden" name="animeId" value="">
        <input type="number" name="score" value="50" step="1" min="0" max="100">
        <input type="submit" value="send">
    </form>
</template>